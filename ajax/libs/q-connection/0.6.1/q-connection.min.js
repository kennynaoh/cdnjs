function debug(){}function Connection(r,e,t){function n(){debug.apply(null,[N].concat(Array.prototype.slice.call(arguments)))}function o(e){n("receive:",e),r.get().then(o),i(e)}function i(r){return r=JSON.parse(r),n("receive: parsed message",r),m[r.type]?u(r.to)?void m[r.type](r):void("function"==typeof t.onmessagelost&&t.onmessagelost(r)):void 0}function u(r){return r===rootId?!0:v.has(r)}function a(r){return r===rootId?d:v.get(r)}function c(r){if(u(r))return a(r).promise;var e=Q.defer();return v.set(r,e),e.promise}function f(r,e,t){a(r)[e](t)}function s(e){return Q.makePromise({when:function(){return this}},function(t,o){var i=l(),u=c(i);return n("sending:","R"+JSON.stringify(e),JSON.stringify(t),JSON.stringify(p(o))),r.put(JSON.stringify({type:"send",to:e,from:i,op:t,args:p(o)})),u})}function p(r,e,t){if(e=e||new Map,t=t||"",void 0===r)return{"%":"undefined"};if(Object(r)!==r){if("number"==typeof r){if(r===Number.POSITIVE_INFINITY)return{"%":"+Infinity"};if(r===Number.NEGATIVE_INFINITY)return{"%":"-Infinity"};if(isNaN(r))return{"%":"NaN"}}return r}var n;if(e.has(r))return{$:e.get(r)};if(e.set(r,t),Q.isPromise(r)||"function"==typeof r)return n=l(),c(n),f(n,"resolve",r),{"@":n,type:typeof r};if(Array.isArray(r))return r.map(function(r,n){return p(r,e,t+"/"+n)});if(r.constructor===Object&&Object.getPrototypeOf(r)===Object.prototype||r instanceof Error){var o={};r instanceof Error&&(o.message=r.message,o.stack=r.stack);for(var i in r)if(has.call(r,i)){var u=i.replace(/[@!%\$\/\\]/,function(r){return"\\"+r});o[u]=p(r[i],e,t+"/"+u)}return o}return n=l(),c(n),f(n,"resolve",r),{"@":n,type:typeof r}}function y(r,e,t){if(e=e||new Map,t=t||"",Object(r)!==r)return r;if(void 0!==r.$)return e.get(r.$);if(r["%"])return"undefined"===r["%"]?void 0:"+Infinity"===r["%"]?Number.POSITIVE_INFINITY:"-Infinity"===r["%"]?Number.NEGATIVE_INFINITY:"NaN"===r["%"]?Number.NaN:Q.reject(new TypeError("Unrecognized type: "+r["%"]));if(r["!"])return Q.reject(r["!"]);if(r["@"]){var n=s(r["@"]);return"function"===r.type?function(){return Q.fapply(n,Array.prototype.slice.call(arguments))}:n}var o=Array.isArray(r)?[]:{};e.set(t,o);for(var i in r)if(has.call(r,i)){var u=i.replace(/\\([\\!@%\$\/])/,function(r,e){return e});o[u]=y(r[i],e,t+"/"+i)}return o}t=t||{};var l=t.makeId||function(){return UUID.generate()},d=Q.defer();d.resolve(e);var v=LruMap(null,t.capacity||t.max||1/0);r=adapt(r,t.origin);var N=Math.random().toString(16).slice(2,4).toUpperCase()+":";r.get().then(o),r.closed&&r.closed.then(function(r){"object"!=typeof r&&(r=new Error(r));var e=new Error("Connection closed because: "+r.message);e.cause=r,v.forEach(function(r){r.reject(e)})});var m={resolve:function(r){u(r.to)&&f(r.to,"resolve",y(r.resolution))},notify:function(r){u(r.to)&&f(r.to,"notify",y(r.resolution))},send:function(e){var t,n=a(e.to).promise,o=n.dispatch(e.op,y(e.args));o.then(function(n){try{n=p(n)}catch(o){try{n={"!":p(o)}}catch(i){n={"!":null}}}t=JSON.stringify({type:"resolve",to:e.from,resolution:n}),r.put(t)},function(n){try{n=p(n)}catch(o){try{n=p(o)}catch(i){n=null}}t=JSON.stringify({type:"resolve",to:e.from,resolution:{"!":n}}),r.put(t)},function(n){try{n=p(n),t=JSON.stringify({type:"notify",to:e.from,resolution:n})}catch(o){try{n={"!":p(o)}}catch(i){n={"!":null}}t=JSON.stringify({type:"resolve",to:e.from,resolution:n})}r.put(t)}).done()}};return s(rootId)}var Q=require("q"),LruMap=require("collections/lru-map"),Map=require("collections/map"),UUID=require("./lib/uuid"),adapt=require("./adapt"),rootId="",has=Object.prototype.hasOwnProperty;module.exports=Connection;
//# sourceMappingURL=q-connection.min.js.map